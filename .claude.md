# USISA-PH Laravel Project Context

## Project Overview
This is a Laravel-based project for managing Philippine infrastructure projects (USISA-PH). It includes comprehensive geographic data management for Philippine regions, provinces, cities, municipalities, and barangays using PSA PSGC (Philippine Statistics Authority - Philippine Standard Geographic Code) data.

## Technology Stack

### Core Frameworks
- **PHP**: ^8.2
- **Laravel**: 12.28.1 (Latest v12)
- **Filament**: 4.0.7 (Admin Panel Framework)
- **Database**: PostgreSQL
- **Frontend Build**: Vite 7.0.4
- **CSS Framework**: Tailwind CSS 4.0.0

### Key PHP Packages
- **spatie/laravel-activitylog**: ^4.10 - Activity logging
- **spatie/laravel-permission**: ^6.21 - Roles & permissions
- **spatie/laravel-query-builder**: ^6.3 - API query builder
- **spatie/laravel-sluggable**: ^3.7 - Auto slug generation
- **spatie/laravel-tags**: ^4.10 - Tagging system
- **symfony/dom-crawler**: ^7.3 - Web scraping

### Testing & Development
- **pestphp/pest**: ^4.0 - Testing framework
- **laravel/pail**: ^1.2.2 - Real-time log viewer
- **laravel/pint**: ^1.24 - Code style fixer

## CRITICAL: Filament v4 Conventions

### Action Imports (MUST USE THESE)
```php
// All actions are in Filament\Actions namespace
use Filament\Actions\EditAction;
use Filament\Actions\ViewAction;
use Filament\Actions\DeleteAction;
use Filament\Actions\BulkActionGroup;
use Filament\Actions\DeleteBulkAction;
use Filament\Actions\ForceDeleteBulkAction;
use Filament\Actions\RestoreBulkAction;

// Only custom table actions use this namespace
use Filament\Tables\Actions\Action;
```

### RelationManager Forms
```php
// Use Schema, not Form
use Filament\Schemas\Schema;

public function form(Schema $schema): Schema
{
    return $schema
        ->components([  // Not ->schema([
            // form fields
        ]);
}
```

### Table Configuration
```php
// Tables in separate classes
class RegionsTable
{
    public static function configure(Table $table): Table
    {
        return $table
            ->columns([...])
            ->filters([...])
            ->actions([...]);
    }
}
```

## Database Structure

### Geographic Hierarchy
```
Region (17 records)
  └── Province (81 records)
      └── City/Municipality (1,634 records)
          └── Barangay (42,046 records)
```

### Key Models & Relationships
- `Region` → hasMany → `Province`
- `Province` → belongsTo → `Region`, hasMany → `City`
- `City` → belongsTo → `Province`, hasMany → `Barangay`
- `Barangay` → belongsTo → `City`
- `Project` → belongsTo → `Region`, `Province`, `City`, `Barangay`

### Important Fields
- All geographic models have `uuid` (UUID v7) as primary identifier
- `code` - PSGC code (unique identifier)
- `psa_code` - 10-digit PSA official code
- `psa_slug` - URL-friendly identifier
- `island_group_code` - luzon/visayas/mindanao
- `is_active` - Active status flag

## Data Sources & Import

### PSGC GitLab API
- Base URL: `https://psgc.gitlab.io/api/`
- Endpoints: `/regions.json`, `/provinces.json`, `/cities.json`, `/municipalities.json`, `/barangays.json`

### Import Commands
```bash
# Import all data
php artisan psgc:import --clear

# Import specific type
php artisan psgc:import --type=regions

# Available types: regions, provinces, cities, municipalities, barangays, all
```

## Project-Specific Features

### Scraper System
- Web scraping infrastructure for government project data
- Sources: DIME, PSA websites
- Job queue system for resilient scraping
- ScraperJob, ScraperSource models for tracking

### Project Management
- Projects linked to geographic locations
- Multi-level geographic assignment (region/province/city/barangay)
- Project progress tracking
- Contractor and implementing office management
- Source of funds tracking

### Filament Resources
Key admin panel resources:
- `RegionResource` - With ProvincesRelationManager
- `ProvinceResource` - With CitiesRelationManager
- `CityResource` - With BarangaysRelationManager
- `BarangayResource`
- `ProjectResource` - Main project management
- `ContractorResource`
- `ImplementingOfficeResource`
- `ProgramResource`

## Common Tasks & Solutions

### Adding New Filament Resource
```bash
php artisan make:filament-resource ModelName
```

### Creating Relation Manager
```php
// In Resource file
public static function getRelations(): array
{
    return [
        RelationManagerClass::class,
    ];
}
```

### Database Migrations
```bash
# Run migrations
php artisan migrate

# Rollback
php artisan migrate:rollback

# Fresh migration with seed
php artisan migrate:fresh --seed
```

## Known Issues & Solutions

### PostgreSQL Constraints
- Always use conditional column checks in migrations
- Handle foreign key constraints with `->onDelete('cascade')`

### Filament Search Issues
- Don't use global `->searchable([...])` on tables
- Apply `->searchable()` to individual columns instead

### UUID Generation
- Models use `HasUuid` trait
- Generates UUID v7 (time-ordered) via `Str::orderedUuid()`

## Development Workflow

### Starting Development
```bash
# Install dependencies
composer install
npm install

# Run migrations
php artisan migrate

# Import geographic data
php artisan psgc:import --clear

# Start development servers
composer dev
# Or individually:
php artisan serve
npm run dev
php artisan queue:listen
```

### Testing
```bash
# Run tests
php artisan test
# or
./vendor/bin/pest

# Code style
./vendor/bin/pint
```

## Git Commit Guidelines
- NO AI/Claude mentions in commits
- Use conventional commit format
- Keep commits focused and atomic
- Write clear, descriptive messages

## Environment Variables
Key variables to configure:
- `DB_CONNECTION=pgsql`
- `DB_HOST`, `DB_PORT`, `DB_DATABASE`, `DB_USERNAME`, `DB_PASSWORD`
- `APP_URL` - Set to actual domain
- `QUEUE_CONNECTION=database` - For scraper jobs

## Support & Documentation
- Laravel Docs: https://laravel.com/docs/12.x
- Filament Docs: https://filamentphp.com/docs/4.x
- Spatie Package Docs: https://spatie.be/docs

## Project Maintainer Notes
- Always verify Filament v4 action imports
- Test PostgreSQL migrations thoroughly
- Maintain PSGC data sync quarterly
- Monitor scraper job performance
- Keep geographic hierarchies intact